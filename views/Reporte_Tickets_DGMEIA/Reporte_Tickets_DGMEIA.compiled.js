SalesDashboard.dashboardModel=function(){let b=this;this.Nombre;this.Apellido;this.Estatus=null;b.MisServiciosActivosTickets=[];b.FechaPromesaDefecto=86400;b.__Temp_Ult_Consulta={};let e=$("#loadPanel").dxLoadPanel({hideOnOutsideClick:!1,shadingColor:"rgba(0,0,0,0.4)",showIndicator:!0,showPane:!0,shading:!0,visible:!0}).dxLoadPanel("instance");b.TipoUsuario="ADMIN";b.TimeZoneServidor=localStorage.getItem("tmzServidor");b.TimeZoneEmpleado=localStorage.getItem("tmzEmpleado");b.TiempoUTCEmpleado=DiferencieTimeZones();
b.__DataSource_Tickets_Grid_Admin=new DevExpress.data.ArrayStore({key:"TICKET",data:[]});b.REPORTE_ID_SERVICIO=null;b.REPORTE_FECHA_INICIO=null;b.REPORTE_FECHA_FIN=null;b.__DataSource_Tipificaiones=new DevExpress.data.ArrayStore({data:[]});b._ClienteProyectoCampania_ObjData=new DevExpress.data.ArrayStore({data:[]});b.idServiciosUsuario={};b.init=function(){$("#splashscreen").fadeOut(1E3);Globalize.loadMessages(dictionary);let f=function(){let a=sessionStorage.getItem("locale");return null!=a?a:"es"}();
Globalize.locale(f);DevExpress.localization.locale(f);$("#adm_title_ms").html(Globalize.formatMessage("adm_title_ms"));$("#adm_title_grid").html(Globalize.formatMessage("adm_title_grid"));b.patname=window.location.pathname;JSON.parse(localStorage.getItem("obj_DatosEmpleado"));b.Frm_Busqueda_filtros=$("#__Frm_busqueda_Filtro").dxForm({readOnly:!1,showColonAfterLabel:!0,showValidationSummary:!1,validationGroup:"__Frm_Busqueda_Filtro",labelMode:"outside",labelLocation:"left",colCount:10,minColWidth:200,
items:[{colSpan:2,dataField:"SAMT_REPORTE_SERVICIO_CSC",editorType:"dxSelectBox",label:{text:"Servicio"},editorOptions:{searchEnabled:!0,displayExpr:"REPORTE_SERVICIO_NOMBRE",valueExpr:"SAMT_REPORTE_SERVICIO_CSC",dataSource:new DevExpress.data.DataSource({store:new DevExpress.data.CustomStore({key:"CAT_MES_CLAVE",loadMode:"raw",paginate:!1,load:async function(){return __Get_catalogos(getJSON(DeveloperType).ApiGeneral.url+"Get_Cat","GET",{Tbl:"SAMT_REPORTE_SERVICIO",NACTIVE:"REPORTE_SERVICIO_ACTIVO"},
getJSON(DeveloperType).ApiGeneral.token).then(a=>{if(!0===a.success)return jslinq(a.JsonData).orderBy(c=>c.CAT_MES_CSC).toList();console.log(a.message)})}})}),onValueChanged:function(a){a=a.value;b.REPORTE_ID_SERVICIO=a;b.REPORTE_FECHA_INICIO=null;b.REPORTE_FECHA_FIN=null;let c=b.Frm_Busqueda_filtros.getEditor("SAMT_REPORTE_PERIODO_CSC");c.option("value",null);a={Tbl:"SAMT_REPORTE_PERIODO",WHR:"EMP_CSC_EMPRESA_HOST="+localStorage.getItem("EMP_CSC_EMPRESA_HOST")+" AND SAMT_REPORTE_SERVICIO_CSC="+a};
__Get_catalogos(getJSON(DeveloperType).ApiGeneral.url+"Get_Cat_Whr","GET",a,getJSON(DeveloperType).ApiGeneral.token).then(d=>{c.option("dataSource",d.success?d.JsonData:[])})}},validationRules:[{type:"required",message:"requerido"}]},{colSpan:2,dataField:"SAMT_REPORTE_PERIODO_CSC",editorType:"dxSelectBox",label:{text:"Periodo"},editorOptions:{searchEnabled:!1,displayExpr:"REPORTE_PERIODO_NOMBRE",valueExpr:"SAMT_REPORTE_PERIODO_CSC",onValueChanged:function(a){let c=a.value;console.debug("VALOR SELECCIOANDO "+
c);a=b.Frm_Busqueda_filtros.getEditor("SAMT_REPORTE_PERIODO_CSC");if(a._dataSource&&a._dataSource._items&&(a=a._dataSource._items.find(d=>d.SAMT_REPORTE_PERIODO_CSC===c))){b.REPORTE_FECHA_INICIO=a.REPORTE_PERIODO_FECHA_INICIO;b.REPORTE_FECHA_FIN=a.REPORTE_PERIODO_FECHA_FIN;let d=b.Frm_Busqueda_filtros.option("formData");Object.assign(d,{REPORTE_FECHA_INICIO:a.REPORTE_PERIODO_FECHA_INICIO,SAMT_CAL_CATORCREPORTE_FECHA_FINENA_F2:a.REPORTE_PERIODO_FECHA_FIN});b.Frm_Busqueda_filtros.option("formData",
d)}console.debug("CONSULTA FECHA INICIO"+b.REPORTE_FECHA_INICIO);console.debug("CONSULTA FECHA FIN"+b.REPORTE_FECHA_FIN)}},validationRules:[{type:"required",message:"requerido"}]},{itemType:"button",colSpan:1,buttonOptions:{text:"Consultar",icon:"refresh",type:"success",width:"100%",onClick(){!0===b.Frm_Busqueda_filtros.validate().isValid?b.ConsultarReporte():(e.hide(),DevExpress.ui.notify("LLENE LOS CAMPOS EN ROJO"))}}},{itemType:"button",colSpan:1,buttonOptions:{text:"Exportar a Excel",icon:"export",
type:"success",onClick(){b.DataGridReporte.getDataSource().load().then(a=>{a&&0!==a.length?b.DataGridReporte.exportToExcel(!0):DevExpress.ui.notify("No hay registros para exportar.","warning",3E3)})}}}]}).dxForm("instance");$("#Mod_Tab_Reporte_Ticket").dxTabPanel({animationEnabled:!1,deferRendering:!1,repaintChangesOnly:!1,dataSource:[{title:"Reporte General",template:"tab_gridGeneral",icon:"./images/Icons/Todos.png"}],itemTitleTemplate:function(a,c,d){d.addClass("custom-tab-title");d.append(`<img src="${a.icon}" style="height: 20px; vertical-align: middle; margin-right: 8px;" />`+
`<span style="vertical-align: middle;">${a.title}</span>`)}});b.DataGridReporte=$("#Data_Grid_Reporte").dxDataGrid({dataSource:b.__DataSource_Tickets_Grid_Admin,deferRendering:!0,allowColumnResizing:!0,height:"100%",filterRow:{visible:!1},filterPanel:{visible:!0},headerFilter:{visible:!1},remoteOperations:!1,searchPanel:{visible:!1,highlightCaseSensitive:!0},selection:{mode:"single"},scrolling:{mode:"virtual",showScrollbar:"always",useNative:!0},groupPanel:{visible:!1},grouping:{autoExpandAll:!0},
paging:{enabled:!1,pageIndex:0,pageSize:20},showBorders:!0,showRowLines:!1,showColumnLines:!0,rowAlternationEnabled:!0,columnAutoWidth:!0,export:{enabled:!1},onExporting:function(a){a.cancel=!0;fetch("/mdi/views/Reporte_Tickets_DGMEIA/Plantilla/American.xlsx").then(c=>c.arrayBuffer()).then(c=>(new ExcelJS.Workbook).xlsx.load(c)).then(c=>{const d=c.getWorksheet("Reporte");if(!d)throw Error("La hoja 'Reporte' no existe.");const k=a.component;return k.getDataSource().load().then(m=>{const n=k.getVisibleColumns();
m.forEach((l,p)=>{n.forEach((g,h)=>{h=d.getCell(3+p,h+1);g=g.calculateCellValue?g.calculateCellValue(l):l[g.dataField];h.value=g;h.font={name:"Montserrat",size:11};h.alignment={horizontal:"center"}})});return c})}).then(c=>c.xlsx.writeBuffer()).then(c=>{saveAs(new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),"ReporteBitacoras_"+moment().tz(b.TimeZoneServidor).format("YYYY-MM-DD HH-mm-ss")+".xlsx")}).catch(c=>{console.error("Error al exportar con plantilla:",
c);alert("Error al generar el archivo. Revisa la plantilla o consulta a soporte.")})},columns:[{caption:"No",dataField:"NUMERO",fixed:!0,fixedPosition:"left",alignment:"center"},{caption:"No. Reporte AS&E",dataField:"NO_REPORTE",alignment:"center",fixed:!0,fixedPosition:"left"},{caption:"Aduana",dataField:"ADUANA",alignment:"left"},{caption:"No. de serie del equipo",dataField:"NO_SERIE_EQUIPO",alignment:"center"},{caption:"Descripci\u00f3n del Falla",dataField:"DESCRIPCION_FALLA",alignment:"left",
width:180},{caption:"Inicio de la falla",alignment:"center",columns:[{caption:"Fecha",dataField:"INICIO_FALLA_FECHA",alignment:"center",dataType:"datetime",format:"dd/MM/yyyy"},{caption:"Hora",dataField:"INICIO_FALLA_HORA",alignment:"center",dataType:"time",format:"HH:mm:ss"}]},{caption:"Indicador 1 Tiempo de atenci\u00f3n telef\u00f3nica (2 horas)",alignment:"center",columns:[{caption:"Fecha",dataField:"TIEMPO_ATENCION_TELEFONICA_FECHA",alignment:"center",dataType:"datetime",format:"dd/MM/yyyy"},
{caption:"Hora",dataField:"TIEMPO_ATENCION_TELEFONICA_HORA",alignment:"center",dataType:"time",format:"HH:mm:ss"},{caption:"Tiempo de atenci\u00f3n",dataField:"TIEMPO_ATENCION",alignment:"center",dataType:"time",format:"HH:mm:ss"},{caption:"D\u00edas de deductiva",dataField:"TIEMPO_ATENCION_DIAS_DEDUCTIVA",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}}]},{caption:"Ventana de tiempo (Tiempo no contabilizado por causas ajenas al proveedor no  fue posible realizar la reparaci\u00f3n)",
alignment:"center",columns:[{caption:"De (Fecha)",dataField:"VENTA_TIEMPO_DEFECHA",alignment:"center",dataType:"datetime",format:"dd/MM/yyyy"},{caption:"Hora",dataField:"VENTA_TIEMPO_DEHORA",alignment:"center",dataType:"time",format:"HH:mm:ss"},{caption:"A (fecha)",dataField:"VENTA_TIEMPO_AFECHA",alignment:"center",dataType:"datetime",format:"dd/MM/yyyy"},{caption:"Hora",dataField:"VENTA_TIEMPO_AHORA",alignment:"center",dataType:"time",format:"HH:mm:ss"},{caption:"Tiempo no considerado",dataField:"TIEMPO_NO_CONSIDERADO",
alignment:"center",dataType:"time",format:"HH:mm:ss"}]},{caption:"Indicador 2 Tiempo de reparaci\u00f3n de la falla (96 horas)",alignment:"center",columns:[{caption:"Fecha",dataField:"TIEMPO_REPARACION_FALLA_FECHA",alignment:"center",dataType:"datetime",format:"dd/MM/yyyy"},{caption:"Hora",dataField:"TIEMPO_REPARACION_FALLA_HORA",alignment:"center",dataType:"time",format:"HH:mm:ss"},{caption:"Tiempo de reparaci\u00f3n",dataField:"TIEMPO_REPARACION",alignment:"center",dataType:"time",format:"HH:mm:ss"},
{caption:"D\u00edas de deductiva",dataField:"REPARACION_DIAS_DEDUCTIVA",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}}]},{caption:"Indicador 3 Fallas recurrentes",alignment:"center",columns:[{caption:"Tiempo de reparaci\u00f3n",dataField:"FALLAS_RECURRENTES_TIEMPO_REPARACION",alignment:"center",dataType:"time",format:"HH:mm:ss"},{caption:"D\u00edas de deductiva",dataField:"FALLAS_RECURRENTES_DIAS_DEDUCTIVA",alignment:"center",dataType:"number",format:{type:"fixedPoint",
precision:0}}]},{caption:"D\u00edas de inoperatividad",alignment:"center",columns:[{caption:"D\u00edas ",dataField:"INOPERATIVIDAD_DIAS",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"Horas",dataField:"INOPERATIVIDAD_HORAS",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"Min.",dataField:"INOPERATIVIDAD_MINUTOS",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"%",dataField:"INOPERATIVIDAD_PORCENTAJE",
alignment:"center",dataType:"number",format:{formatter:function(a){if(null==a)return"";a*=100;return 0===a%1?`${a}%`:`${a.toFixed(2)}%`}}}]},{caption:"D\u00edas que el equipo opero",alignment:"center",columns:[{caption:"D\u00edas",dataField:"EQUIPO_OPERO_DIAS",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"Hrs.",dataField:"EQUIPO_OPERO_HORAS",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"Min.",dataField:"EQUIPO_OPERO_MINUTOS",
alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"%",dataField:"EQUIPO_OPERO_PORCENTAJE",alignment:"center",dataType:"number",format:{formatter:function(a){if(null==a)return"";a*=100;return 0===a%1?`${a}%`:`${a.toFixed(2)}%`}}}]},{caption:"Indicador 4\nOperatividad\npor equipo del 95%",alignment:"center",columns:[{caption:"%",dataField:"OPERATIVIDAD_EQUIPO_PORCENTAJE",alignment:"center",dataType:"number",format:{formatter:function(a){if(null==a)return"";a*=100;
return 0===a%1?`${a}%`:`${a.toFixed(2)}%`}}},{caption:"Formula para D\u00edas de deductiva",dataField:"FORMULA_DIAS_DEDUCTIVA",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"D\u00edas",dataField:"OPERATIVIDAD_EQUIPO_DIAS",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"Hrs.",dataField:"OPERATIVIDAD_EQUIPO_HORAS",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"Min.",dataField:"OPERATIVIDAD_EQUIPO_MINUTOS",
alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}},{caption:"Deductivas por inoperatividad",dataField:"OPERATIVIDAD_EQUIPO_DEDUCTIVA",alignment:"center",dataType:"number",format:{type:"fixedPoint",precision:0}}]}],summary:{totalItems:[{name:"Total",showInColumn:"NUMERO",displayFormat:"Total: {0}",summaryType:"count"}]},onRowDblClick:function(a){console.log(a.data)}}).dxDataGrid("instance");e.hide()};b.run=function(){e.hide()};b.ConsultarReporte=function(f){b.__DataSource_Tickets_Grid_Admin.clear();
let a={...ReturnDefaultData_Init()};b.REPORTE_ID_SERVICIO&&b.REPORTE_FECHA_INICIO&&b.REPORTE_FECHA_FIN?(f=Object.assign(a,f,{ID_MESA_SERVICIO:b.REPORTE_ID_SERVICIO,FECHA_INICIAL:b.REPORTE_FECHA_INICIO,FECHA_FINAL:b.REPORTE_FECHA_FIN}),e.show(),__Reques_ajax(getJSON(DeveloperType).ApiTickets_v2.url+"Get_Reporte_dgmeia","GET",f,getJSON(DeveloperType).ApiTickets_v2.token).then(c=>{1==c.success?c.JsonData.forEach(function(d){b.__DataSource_Tickets_Grid_Admin.insert(d)}):b.__DataSource_Tickets_Grid_Admin.clear();
b.DataGridReporte.refresh();e.hide()}).catch(function(c){b.__DataSource_Tickets_Grid_Admin.clear();b.DataGridReporte.refresh();e.hide();DevExpress.ui.notify("Eror de de busqueda vueva a intentar nuevamente","error",3E3)})):DevExpress.ui.notify("Debe seleccionar el servicio y un periodo \u00e1lido.","error",3E3)}};setTimeout(()=>{SalesDashboard.currentModel=new SalesDashboard.dashboardModel;SalesDashboard.currentModel.init();SalesDashboard.currentModel.run()},1E3);
